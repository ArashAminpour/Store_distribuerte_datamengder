TABLES = {}

TABLES['user'] = '''
    CREATE TABLE user (
        id VARCHAR(255) PRIMARY KEY,
        has_labels BOOLEAN
    );
'''

TABLES['activity'] = '''
    CREATE TABLE activity (
        id VARCHAR(255) PRIMARY KEY,
        user_id VARCHAR(255),
        transportation_mode VARCHAR(255),
        start_date_time DATETIME,
        end_date_time DATETIME,
        FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
    );
'''

TABLES['track_point'] = '''
    CREATE TABLE track_point (
        id INT PRIMARY KEY AUTO_INCREMENT,
        activity_id VARCHAR(255),
        lat DOUBLE,
        lon DOUBLE,
        altitude INT,
        date_days DOUBLE,
        date_time DATETIME,
        FOREIGN KEY (activity_id) REFERENCES activity(id) ON DELETE CASCADE
    );
'''

QUERIES = {}

QUERIES['1a'] = """
    SELECT COUNT(distinct id) AS distinct_users, COUNT(*) AS num_users
    FROM user;
"""

QUERIES['1b'] = """
    SELECT COUNT(distinct id) AS distinct_activities, COUNT(*) AS num_activities 
    FROM activity;
"""

QUERIES['1c'] = """ 
    SELECT COUNT(distinct id) AS distinct_trackpoints, COUNT(*) AS num_trackpoints
    FROM track_point;
"""

QUERIES['2'] = """
    WITH user_tp_count AS (
        SELECT user_id, count(*) AS tp_count
        FROM track_point tp JOIN activity a ON a.id = tp.activity_id
        JOIN user u ON a.user_id = u.id
        GROUP BY user_id
    )
    SELECT MIN(tp_count), MAX(tp_count), AVG(tp_count) FROM user_tp_count;
"""

QUERIES['3'] = """ 
    SELECT user_id, count(id) AS activity_count
    FROM activity
    GROUP BY user_id
    ORDER BY activity_count DESC
    LIMIT 15;
"""

QUERIES['4'] = """
    SELECT DISTINCT user_id, transportation_mode  
    FROM activity
    WHERE transportation_mode = "bus"
    ORDER BY user_id;
"""

QUERIES['5'] = """
    SELECT 
        user_id, 
        COUNT(DISTINCT transportation_mode) AS num_of_different_transport_mode
    FROM activity
    GROUP BY user_id
    ORDER BY num_of_different_transport_mode DESC
    LIMIT 10;
"""

QUERIES['6'] = """
    SELECT id, COUNT(*) AS activity_count
    FROM activity 
    GROUP BY id
    HAVING COUNT(*) > 1 
    ORDER BY activity_count DESC;
"""

QUERIES['7a'] = """
    SELECT COUNT(DISTINCT user_id) as number_of_users
    FROM activity a 
    WHERE TIMESTAMPDIFF(DAY, a.start_date_time, a.end_date_time) >= 1;
"""

QUERIES['7b'] = """
    SELECT a.transportation_mode, user_id, 
    CONCAT(
        TIMESTAMPDIFF(DAY, a.start_date_time, a.end_date_time), ' days ',
        HOUR(TIMEDIFF(a.end_date_time, a.start_date_time)), ' hours ',
        MINUTE(TIMEDIFF(a.end_date_time, a.start_date_time)), ' minutes ',
        SECOND(TIMEDIFF(a.end_date_time, a.start_date_time)), ' seconds'
    ) AS duration
    FROM activity a
    WHERE TIMESTAMPDIFF(DAY, a.start_date_time, a.end_date_time) >= 1
    ORDER BY user_id;
"""

QUERIES['9'] = """
    WITH alt_diff AS(
        SELECT 
            tp.activity_id, 
            tp.altitude * 0.3048 as current_altitude_meters, 
            LAG(tp.altitude * 0.3048) OVER (
                PARTITION BY tp.activity_id 
                ORDER BY date_time
            ) AS prev_altitude_meters
        FROM track_point tp
        WHERE tp.altitude != -777 
    ), 

    altitude_gained AS(
        SELECT 
            ad.activity_id, 
            SUM(
                CASE 
                    WHEN ad.current_altitude_meters > ad.prev_altitude_meters 
                        THEN ad.current_altitude_meters - ad.prev_altitude_meters 
                    ELSE 0 END
            ) AS altitude_meters_gain
        FROM alt_diff ad
        GROUP BY ad.activity_id
    )

    SELECT a.user_id, SUM(ag.altitude_meters_gain) AS total_altitude_meters_gained
    FROM activity a
    JOIN altitude_gained ag ON a.id = ag.activity_id
    GROUP BY a.user_id
    ORDER BY SUM(ag.altitude_meters_gain) DESC 
    LIMIT 15;
"""

QUERIES['11'] = """
    WITH track_point_diff AS(
        SELECT 
            tp.activity_id, 
            tp.date_time, 
            TIMESTAMPDIFF(
                MINUTE, 
                tp.date_time, 
                LEAD(tp.date_time) OVER (
                    PARTITION BY tp.activity_id 
                    ORDER BY tp.date_time
                )
            ) AS minute_diff 
        FROM track_point tp
    ) 
    SELECT 
        a.user_id, 
        COUNT(DISTINCT tpd.activity_id) AS invalid_activities_number 
    FROM track_point_diff tpd 
    JOIN activity a ON tpd.activity_id = a.id 
    WHERE tpd.minute_diff >= 5 
    GROUP BY a.user_id 
    ORDER BY COUNT(DISTINCT tpd.activity_id) DESC;
"""

QUERIES['12'] = """
    WITH filter_user_transportation AS(
        SELECT DISTINCT
            user_id, 
            transportation_mode,
            count(*) as count,
            ROW_NUMBER() OVER(PARTITION BY user_id ORDER BY count(*) DESC) AS row_num
        FROM activity
        WHERE transportation_mode IS NOT NULL
        GROUP BY user_id, transportation_mode
        ORDER BY user_id, count(*) DESC
    ) 
    SELECT
        user_id, 
        transportation_mode,
        count
    FROM filter_user_transportation
    WHERE row_num = 1;
"""

# Saved to file to avoid long proesssing time
TASK8_OUTPUT = {
('000', '004'): ('20081029093038000', '20081029052125004'),
('000', '015'): ('20081112023003000', '20081112000936015'),
('000', '030'): ('20090412004905000', '20090412004858030'),
('000', '005'): ('20081115010133000', '20081115010304005'),
('000', '003'): ('20090330005208000', '20090330005208003'),
('001', '004'): ('20081111234235001', '20081112063539004'),
('001', '014'): ('20081029234123001', '20081029234245014'),
('001', '015'): ('20081111234235001', '20081112000936015'),
('001', '084'): ('20081104054859001', '20081104102003084'),
('001', '128'): ('20081114130723001', '20081114131233128'),
('003', '004'): ('20081023175854003', '20081023175852004'),
('003', '005'): ('20081027041826003', '20081027092607005'),
('003', '028'): ('20090210022307003', '20090210091805028'),
('003', '030'): ('20090208020837003', '20090208020851030'),
('003', '015'): ('20090303004756003', '20090303004804015'),
('003', '096'): ('20081115014037003', '20081115015705096'),
('003', '126'): ('20090114110149003', '20090114122432126'),
('003', '179'): ('20081115014037003', '20081115015705179'),
('004', '005'): ('20081106193827004', '20081106160526005'),
('003', '167'): ('20090114110149003', '20090114122432167'),
('004', '015'): ('20081029052125004', '20081028235159015'),
('004', '030'): ('20090112195936004', '20090113023222030'),
('004', '028'): ('20090224230528004', '20090224223025028'),
('004', '032'): ('20081216013032004', '20081216112008032'),
('004', '034'): ('20090313030256004', '20090313110440034'),
('004', '025'): ('20090313030256004', '20090313105308025'),
('004', '062'): ('20081207051527004', '20081207083840062'),
('004', '128'): ('20081208013636004', '20081208115031128'),
('005', '030'): ('20090224010335005', '20090224003703030'),
('006', '015'): ('20081023065939006', '20081023024930015'),
('006', '016'): ('20081112001438006', '20081112000105016'),
('006', '007'): ('20081116060235006', '20081116091403007'),
('008', '012'): ('20081028102134008', '20081028092335012'),
('008', '084'): ('20081024132624008', '20081024130403084'),
('009', '012'): ('20081112001804009', '20081112013253012'),
('010', '124'): ('20081003221227010', '20081003221227124'),
('011', '017'): ('20081110081234011', '20081110075608017'),
('011', '088'): ('20080926104408011', '20080926104408088'),
('011', '062'): ('20081112091111011', '20081112101140062'),
('012', '042'): ('20081005084409012', '20081005094109042'),
('012', '127'): ('20080927005735012', '20080927005735127'),
('013', '015'): ('20081020092505013', '20081020092056015'),
('012', '144'): ('20081203012029012', '20081203094240144'),
('012', '126'): ('20081122143235012', '20081122143235126'),
('012', '167'): ('20081122143235012', '20081122143235167'),
('013', '014'): ('20081203232323013', '20081203234207014'),
('013', '070'): ('20080927120819013', '20080927120819070'),
('013', '062'): ('20081017093105013', '20081017085919062'),
('014', '015'): ('20081028000349014', '20081027235238015'),
('013', '068'): ('20081201090935013', '20081201075005068'),
('014', '016'): ('20081107081230014', '20081107090805016'),
('014', '036'): ('20090302050308014', '20090302045708036'),
('014', '032'): ('20081216235109014', '20081216234852032'),
('014', '017'): ('20081203234207014', '20081204000245017'),
('014', '062'): ('20081105102527014', '20081105102345062'),
('014', '035'): ('20090302080947014', '20090302071635035'),
('015', '032'): ('20081202105722015', '20081202105722032'),
('015', '017'): ('20081107091356015', '20081107091420017'),
('014', '126'): ('20090120060039014', '20090120055508126'),
('014', '167'): ('20090120060039014', '20090120055508167'),
('017', '024'): ('20090217001316017', '20090216232537024'),
('014', '128'): ('20090318054636014', '20090318082038128'),
('017', '142'): ('20081224045030017', '20081224055406142'),
('017', '025'): ('20090702094931017', '20090702091404025'),
('018', '062'): ('20081106024303018', '20081106024201062'),
('018', '019'): ('20081214093422018', '20081214092748019'),
('020', '102'): ('20111115013237020', '20111115012432102'),
('020', '165'): ('20111025142225020', '20111025140340165'),
('022', '043'): ('20090219110435022', '20090219094257043'),
('022', '044'): ('20090327003702022', '20090326232732044'),
('023', '043'): ('20090214032849023', '20090214032955043'),
('025', '034'): ('20090313105308025', '20090313110440034'),
('025', '037'): ('20090402044230025', '20090402050032037'),
('025', '083'): ('20090110114230025', '20090110113232083'),
('025', '039'): ('20090321060146025', '20090321050936039'),
('028', '044'): ('20090309222637028', '20090309232537044'),
('028', '043'): ('20090319222233028', '20090320020330043'),
('029', '038'): ('20090316090503029', '20090316092545038'),
('030', '044'): ('20090325004303030', '20090325051859044'),
('025', '128'): ('20090614085036025', '20090614070352128'),
('034', '044'): ('20090227114002034', '20090227100953044'),
('034', '035'): ('20090219035926034', '20090218215133035'),
('034', '128'): ('20090310123126034', '20090310124033128'),
('034', '037'): ('20090326100917034', '20090326100941037'),
('037', '041'): ('20090227021015037', '20090227040433041'),
('042', '085'): ('20081009044615042', '20081009044230085'),
('042', '096'): ('20081013141537042', '20081013141459096'),
('042', '127'): ('20081005094109042', '20081005084409127'),
('043', '044'): ('20090327004006043', '20090326232732044'),
('045', '067'): ('20100812153736045', '20100812145200067'),
('044', '085'): ('20090322092507044', '20090322095236085'),
('047', '055'): ('20070801104700047', '20070801023506055'),
('046', '169'): ('20100511101325046', '20100511102403169'),
('044', '128'): ('20090309103618044', '20090309092439128'),
('046', '113'): ('20100519002637046', '20100519003829113'),
('047', '061'): ('20070809003538047', '20070808234118061'),
('051', '104'): ('20071130173419051', '20071130143451104'),
('051', '110'): ('20071130173419051', '20071130143734110'),
('055', '075'): ('20110803091252055', '20110803091252075'),
('052', '167'): ('20080825085006052', '20080825091332167'),
('056', '114'): ('20071019052441056', '20071019052429114'),
('056', '082'): ('20071128123035056', '20071128123035082'),
('057', '061'): ('20070731114843057', '20070731115055061'),
('057', '150'): ('20070731114843057', '20070731114843150'),
('057', '094'): ('20070731114843057', '20070731114843094'),
('056', '115'): ('20071128123035056', '20071128123035115'),
('057', '157'): ('20070731114843057', '20070731114756157'),
('056', '128'): ('20071128123035056', '20071128123035128'),
('056', '175'): ('20071019052441056', '20071019052315175'),
('061', '094'): ('20070731115055061', '20070731114843094'),
('056', '163'): ('20071019052441056', '20071019015704163'),
('061', '150'): ('20070731115055061', '20070731114843150'),
('061', '162'): ('20070802120435061', '20070802120734162'),
('058', '059'): ('20110309105252058', '20110309105252059'),
('061', '157'): ('20070731115055061', '20070731114756157'),
('062', '064'): ('20080815075832062', '20080815074715064'),
('064', '096'): ('20080826002736064', '20080826011559096'),
('067', '095'): ('20101206191924067', '20101206191924095'),
('069', '129'): ('20080501232404069', '20080501232453129'),
('071', '074'): ('20120201141033071', '20120201141229074'),
('073', '078'): ('20080529155904073', '20080529155909078'),
('071', '159'): ('20120412235005071', '20120413005853159'),
('073', '112'): ('20080529155904073', '20080529155631112'),
('073', '096'): ('20080806012852073', '20080806012229096'),
('073', '128'): ('20080530121116073', '20080530120255128'),
('073', '136'): ('20080530121116073', '20080530054607136'),
('073', '153'): ('20080530121116073', '20080530120255153'),
('073', '167'): ('20080716101931073', '20080716101735167'),
('076', '128'): ('20070419002322076', '20070419015158128'),
('078', '093'): ('20080819020653078', '20080819051710093'),
('078', '112'): ('20080508093316078', '20080508094734112'),
('078', '084'): ('20080723145229078', '20080723104334084'),
('081', '125'): ('20080509081231081', '20080509081231125'),
('081', '136'): ('20080509081231081', '20080509081231136'),
('078', '085'): ('20080723145229078', '20080723104334085'),
('081', '153'): ('20080530065051081', '20080530063801153'),
('078', '167'): ('20080819020653078', '20080819040135167'),
('081', '112'): ('20080530065051081', '20080530063309112'),
('082', '084'): ('20090404024103082', '20090404031734084'),
('082', '115'): ('20071128123035082', '20071128123035115'),
('082', '163'): ('20071128123035082', '20071128095038163'),
('082', '128'): ('20071128123035082', '20071128123035128'),
('081', '128'): ('20080530065051081', '20080530063801128'),
('084', '085'): ('20080721232434084', '20080721232434085'),
('084', '126'): ('20081203130756084', '20081203151159126'),
('085', '126'): ('20081009044230085', '20081009042429126'),
('085', '155'): ('20090622012237085', '20090622011104155'),
('084', '153'): ('20081025095702084', '20081025095936153'),
('087', '111'): ('20070817145052087', '20070817145052111'),
('084', '167'): ('20081203130756084', '20081203151159167'),
('089', '144'): ('20080428110410089', '20080428110410144'),
('089', '163'): ('20080430122539089', '20080430122452163'),
('089', '153'): ('20080510110634089', '20080510111115153'),
('085', '167'): ('20081009044230085', '20081009042429167'),
('091', '163'): ('20071122165353091', '20071122164907163'),
('092', '101'): ('20071130143600092', '20071130143617101'),
('092', '104'): ('20071130143600092', '20071130143451104'),
('092', '109'): ('20071130143600092', '20071130143617109'),
('084', '128'): ('20081128135605084', '20081128094132128'),
('094', '150'): ('20070731114843094', '20070731114843150'),
('094', '157'): ('20070731114843094', '20070731114756157'),
('092', '115'): ('20080714074403092', '20080714065739115'),
('093', '167'): ('20080819051710093', '20080819040135167'),
('096', '167'): ('20080716112753096', '20080716101735167'),
('096', '128'): ('20080813010535096', '20080813004435128'),
('096', '179'): ('20081026113752096', '20081026113752179'),
('101', '104'): ('20071130143617101', '20071130143451104'),
('101', '109'): ('20071130143617101', '20071130143617109'),
('096', '126'): ('20080919035429096', '20080919035438126'),
('100', '116'): ('20110803093537100', '20110803091631116'),
('101', '173'): ('20071130143617101', '20071130143633173'),
('101', '126'): ('20080522095436101', '20080522095436126'),
('101', '174'): ('20071227135255101', '20071227124344174'),
('104', '109'): ('20071130143451104', '20071130143617109'),
('085', '128'): ('20090509025852085', '20090509025010128'),
('096', '153'): ('20080724105004096', '20080724131623153'),
('104', '173'): ('20071130143451104', '20071130143633173'),
('108', '139'): ('20071002142515108', '20071002142515139'),
('109', '173'): ('20071130143617109', '20071130143633173'),
('110', '167'): ('20080320004131110', '20080320004131167'),
('105', '106'): ('20071009070104105', '20071008231624106'),
('111', '128'): ('20070415004923111', '20070414234445128'),
('112', '163'): ('20080428131300112', '20080428131300163'),
('112', '142'): ('20080520113416112', '20080520113618142'),
('112', '125'): ('20080530063309112', '20080530065051125'),
('112', '136'): ('20080530063309112', '20080530054607136'),
('112', '153'): ('20080530063309112', '20080530063801153'),
('114', '163'): ('20071019052429114', '20071019015704163'),
('114', '175'): ('20071019052429114', '20071019052315175'),
('113', '169'): ('20100513102400113', '20100513105328169'),
('112', '128'): ('20080530063309112', '20080530063801128'),
('114', '128'): ('20100604132602114', '20100604132706128'),
('112', '167'): ('20080520113416112', '20080520113416167'),
('115', '128'): ('20071128123035115', '20071128123035128'),
('115', '140'): ('20080818151615115', '20080818151615140'),
('115', '163'): ('20071128123035115', '20071128095038163'),
('115', '167'): ('20080507011357115', '20080507013834167'),
('117', '128'): ('20070629150221117', '20070629150321128'),
('125', '136'): ('20080509081231125', '20080509081231136'),
('125', '153'): ('20080530065051125', '20080530063801153'),
('125', '128'): ('20080530065051125', '20080530063801128'),
('126', '129'): ('20080516102407126', '20080516102928129'),
('126', '167'): ('20080402174247126', '20080402104425167'),
('126', '174'): ('20080522095436126', '20080522093956174'),
('128', '153'): ('20070721050708128', '20070721050708153'),
('126', '128'): ('20080517014739126', '20080517020041128'),
('128', '136'): ('20080530063801128', '20080530054607136'),
('128', '163'): ('20071128123035128', '20071128095038163'),
('128', '142'): ('20080519013642128', '20080519014437142'),
('128', '170'): ('20080429013145128', '20080429013805170'),
('128', '179'): ('20080905010442128', '20080905010935179'),
('128', '155'): ('20090709130646128', '20090709130404155'),
('134', '161'): ('20070424042157134', '20070424041508161'),
('134', '142'): ('20070424061335134', '20070424013426142'),
('136', '153'): ('20080530054607136', '20080530063801153'),
('142', '161'): ('20070412093132142', '20070412102325161'),
('142', '163'): ('20070412093132142', '20070412102116163'),
('128', '140'): ('20080924064907128', '20080924020707140'),
('128', '167'): ('20080718014139128', '20080718020353167'),
('144', '163'): ('20080430122539144', '20080430122452163'),
('142', '167'): ('20080520113618142', '20080520113416167'),
('144', '153'): ('20080510110634144', '20080510111115153'),
('150', '157'): ('20070731114843150', '20070731114756157'),
('142', '169'): ('20100604013359142', '20100604012003169'),
('153', '163'): ('20080405011127153', '20080405011127163'),
('161', '163'): ('20070412101853161', '20070412102116163'),
('163', '175'): ('20071019015704163', '20071019052315175'),
('164', '176'): ('20071130075508164', '20071130093310176')
}